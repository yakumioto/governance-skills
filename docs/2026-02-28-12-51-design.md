# 设计文档（Design）：governance-skills 全局设计

**创建时间（Created）：** 2026-02-28-12-51

---

## 写作约束（Writing Rules）
- **必须严格按本模板分节输出**，不要新增/合并/改名章节。
- **列表项必须编号**：G/NG/D/AC/R/Q 使用 `[G1]` / `[AC1]` 等格式。
- **只写项目级内容**：不拆 Tasks、不写逐条 Feature 验收、不写实现步骤清单（实现细节进入 Feature 文档）。
- **项目级验收标准（AC）固定三要素**：Outcome / Metric-Threshold / Measurement。
- 每节**最多 5 条**（确需超过请在该节末尾写"见附录/见链接"）。

---

## 1. 项目概述（Project Overview）

governance-skills 是一个通用 AI 治理技能库，用于规范和管理 AI 辅助开发过程中的文档生成与任务执行。核心是通过结构化的技能和模板，建立可追溯、可审计的开发流程。

项目采用技能为中心的架构，以四个核心技能（design/feat/fix/execute）为主体，每个技能独立实现完整的流程逻辑，包括：读取设计文档 → 执行冲突检查 → 调用模板生成 → 写入目标文档。

技能库支持 Claude Code 原生集成，目标用户是技能库的开发者。治理文档存储在用户项目中，模板采用显式版本化管理策略。

---

## 2. 范围界定（Scope）

### 2.1 范围内（In scope）
- 四层治理流程：design → feat → tasks → execute
- 四个核心技能：design、feat、fix、execute
- 文档模板：design.md、feature.md、tasks.md、execute.md
- 编号与引用体系：G/NG/D/AC/R/Q、FR/NFR/TC/IP/DEP
- 冲突检测机制：基于 FR/AC 编号的细粒度匹配
- Scope 定义模式：Allowed/Forbidden/Out of scope
- 验收标准三要素：Outcome / Metric-Threshold / Measurement

### 2.2 范围外（Out of scope）
- 具体的代码实现逻辑（由 feat/tasks/execute 处理）
- CI/CD 集成（未来扩展）
- 可视化界面（CLI 为主要交互方式）
- 第三方技能市场（未来扩展）

### 2.3 前置假设（Assumptions）
- 用户使用 Claude Code 作为主要 AI 开发平台
- 用户项目有 `docs/` 目录用于存储治理文档
- 用户理解 Conventional Commits 规范（用于 commit）

---

## 3. 目标（Goals）

- [G1] 提供标准化的四层治理流程，使 AI 辅助开发过程可追溯、可审计
- [G2] 通过技能为中心的架构，确保 Claude Code 原生体验的流畅性
- [G3] 建立编号与引用体系，实现跨文档的可追溯性
- [G4] 实现冲突检测机制，避免重复实现与回归
- [G5] 支持模板显式版本化，确保文档结构的稳定性

## 4. 非目标（Non-goals）

- [NG1] 不追求立即支持所有 AI 平台（Claude Code 优先）
- [NG2] 不提供图形化用户界面
- [NG3] 不自动执行代码变更（仅生成文档和任务）
- [NG4] 不替代现有的项目管理工具（如 JIRA、Linear）

---

## 5. 架构设计（Architecture）

### 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    AI 开发平台层                               │
│  (Claude Code / Copilot / Cursor / 通用 CLI)                 │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│                   技能调用适配层                                │
│  - 命令解析 (/design, /feat, /fix, /execute)                │
│  - 权限检查 (Read/Write 执行环境)                              │
│  - 参数传递 (需求描述、任务 ID 等)                            │
└────────────────────┬────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│                     技能层                                   │
│  ┌────────┐  ┌────────┐  ┌───────┐  ┌──────────┐           │
│  │ design │  │  feat  │  │  fix  │  │ execute  │           │
│  └────┬───┘  └───┬────┘  └───┬───┘  └────┬─────┘           │
└───────┼──────────┼───────────┼────────────┼─────────────────┘
        │          │           │            │
        ▼          ▼           ▼            ▼
  ┌──────────────────────────────────────────────────┐
  │                  公共服务层                        │
  │  - 模板加载器 (templates/)                        │
  │  - 编号生成器 (G/NG/D/AC/R/Q...)                  │
  │  - 冲突检测器 (基于 FR/AC)                        │
  │  - Scope 验证器 (Allowed/Forbidden)              │
  └──────────────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────────┐
│                   资源层                                     │
│  - 文档模板 (templates/*.md)                                │
│  - 治理文档 (docs/design/, docs/features/, docs/tasks/, docs/executes/)
│  - 用户项目文件系统                                         │
└─────────────────────────────────────────────────────────────┘
```

### 技能流程

```
design 流程：
  1. 发现并读取最新 Design (docs/*-design.md)
  2. 调用 brainstorming 分析需求
  3. 加载 templates/design.md
  4. 填充模板字段并写入新文档

feat 流程：
  1. 读取最新 Design
  2. 读取相关 Feature/Tasks
  3. 执行冲突检查 (扫描历史 execute 记录)
  4. 调用 brainstorming
  5. 生成 Feature 文档 (templates/feature.md)
  6. 生成 Tasks 文档 (templates/tasks.md)

fix 流程：
  1. 读取最新 Design
  2. 读取相关 Feature/Tasks
  3. 执行冲突检查
  4. 调用 brainstorming
  5. 生成 Tasks 文档 (包含复现→修复→回归闭环)

execute 流程：
  1. 读取指定 Task 文档
  2. 提取 Scope 和 Acceptance 信息
  3. 生成环境快照
  4. 执行 Scope 强制检查
  5. 按 Scope 执行变更
  6. 运行验收命令
  7. 生成 Execute 文档 (templates/execute.md)
```

### 5.1 关键决策（Key Decisions）

- [D1] **决策（Decision）：** 采用技能为中心的架构，每个技能独立实现完整流程。
  **理由（Rationale）：** 与 Claude Code 的 Skill 模型原生契合，简单直接，易于理解和维护。符合 Claude Code 优先的设计原则。
  **影响（Impact）：** 技能间可能有少量重复逻辑（如冲突检测），但降低了整体复杂度。

- [D2] **决策（Decision）：** 模板文件作为只读资源，存储在技能库的 `templates/` 目录。
  **理由（Rationale）：** 确保文档结构的一致性，防止用户误修改模板导致流程混乱。
  **影响（Impact）：** 模板演进需要发布新版本技能库，配合显式版本化策略。

- [D3] **决策（Decision）：** 治理文档存储在用户项目的 `docs/` 目录。
  **理由（Rationale）：** 文档与代码同仓库，便于版本控制和 PR 审查。支持多项目独立管理。
  **影响（Impact）：** 用户需要在每个使用项目安装技能库，但可独立演化治理流程。

- [D4] **决策（Decision）：** 冲突检测基于 FR/AC 编号级别的细粒度匹配。
  **理由（Rationale）：** 编号是跨文档引用的核心，基于编号的匹配既准确又易于实现。
  **影响（Impact）：** 需要确保所有文档严格使用编号体系，但能有效避免重复实现。

- [D5] **决策（Decision）：** 采用编号与引用体系（G/NG/D/AC/R/Q；FR/NFR/TC/IP/DEP）。
  **理由（Rationale）：** 简洁的命名空间便于机器解析和人工阅读，支持跨文档追踪。
  **影响（Impact）：** 需要在文档生成时自动分配编号，并在引用时验证有效性。

### 5.2 接口 / 契约（Interfaces / Contracts）
> 参数名、配置键、API path、schema 字段名 **保持英文原样**。
- **输入（Inputs）：**
  - `/design <需求描述>` — 生成全局设计文档
  - `/feat <功能描述>` — 生成 Feature + Tasks
  - `/fix <问题描述>` — 生成修复 Tasks
  - `/execute <task-file>:<task-id>` — 执行指定任务
- **输出（Outputs）：**
  - `docs/YYYY-MM-DD-HH-MM-design.md` — 设计文档
  - `docs/features/YYYY-MM-DD-HH-MM-<name>.md` — 功能文档
  - `docs/tasks/YYYY-MM-DD-HH-MM-<name>.md` — 任务清单
  - `docs/executes/YYYY-MM-DD-HH-MM-<name>-<task-id>.md` — 执行记录
- **契约（Schema / API Contract）：**
  - 时间戳格式：`YYYY-MM-DD-HH-MM`（24 小时制）
  - 编号格式：`[类型]编号`，如 `[G1]`、`[FR2]`、`[AC1]`
  - Scope 格式：`Allowed: <list>`, `Forbidden: <list>`, `Out of scope: <list>`
  - AC 三要素：`Outcome` / `Metric-Threshold` / `Measurement`

---

## 6. 约束条件

- **性能（Performance）：** 不适用（项目为文档生成与任务管理，无实时性能要求）
- **可靠性（Reliability）：** 模板文件读取失败必须显式报错并停止执行，不得生成部分文档
- **安全/隐私（Security/Privacy）：** 执行记录中的敏感配置信息必须打码处理
- **兼容性（Compatibility）：** 模板演进必须向后兼容至少一个大版本
- **成本/运维（Cost/Operational）：** 治理文档采用 Markdown 文本格式，无需额外存储成本

---

## 7. 项目级验收标准（Project-level Acceptance Criteria / Success Criteria）
> 仅定义跨 Feature 的项目级成功标准；不写 UI/交互细节，不写逐条功能测试用例。

- [AC1] **结果（Outcome）：** 四个核心技能能够独立生成对应的文档
  **指标/阈值：** design/feat/fix/execute 各生成 1 份有效文档
  **度量方式：** 文档文件存在于 `docs/` 目录对应子目录，且通过模板结构校验

- [AC2] **结果（Outcome）：** 文档间引用关系完整可追溯
  **指标/阈值：** 每层文档显式引用其父层的设计决策（如 `[G1] [D2] [AC1]`）
  **度量方式：** 脚本解析文档引用链，验证编号存在且格式正确

- [AC3] **结果（Outcome）：** 冲突检测能够识别重复实现
  **指标/阈值：** 当生成的新文档与历史 execute 记录覆盖同一 FR/AC 时标记冲突
  **度量方式：** 创建两个覆盖相同需求的 feat，验证第二个 feat 报告冲突

- [AC4] **结果（Outcome）：** Execute 流程能够生成可审计的执行证据
  **指标/阈值：** 执行记录包含环境快照、执行命令、断言结果、产物链接
  **度量方式：** 执行任务后，通过执行记录完整还原变更过程

- [AC5] **结果（Outcome）：** 模板文件保持只读状态
  **指标/阈值：** `templates/` 目录下所有文件从未被技能修改
  **度量方式：** 技能执行前后校验模板文件的 SHA256 哈希值一致

（建议 3–7 条；超过则下沉到 Feature 文档）

---

## 8. 风险与应对（Risks & Mitigations）

- [R1] **风险（Risk）：** 用户未遵循编号体系导致引用链断裂 → **应对（Mitigation）：** 技能在生成文档时自动分配编号，并在生成后验证引用有效性
- [R2] **风险（Risk）：** 多人同时生成文档导致编号冲突 → **应对（Mitigation）：** 编号以时间戳前缀区分不同文档，同文档内编号自动递增
- [R3] **风险（Risk）：** 模板演进导致旧文档无法解析 → **应对（Mitigation）：** 显式版本化策略，提供迁移工具支持旧版本升级
- [R4] **风险（Risk）：** 冲突检测误报（不同描述但实际是同一功能） → **应对（Mitigation）：** 允许用户手动确认/忽略冲突警告，但必须记录决策理由

---

## 9. 未决问题（Open Questions）

- [Q1] 模板版本号是否需要在文档中显式记录？（如 `Template Version: 1.0`）
- [Q2] 当检测到冲突时，是否需要提供自动合并建议？
- [Q3] 受保护目录（`docs/spec/`、`docs/tasks/`、`docs/changes/`）是否需要额外的权限控制机制？

---

## 10. 参考资料（References）

- **模板文件：** `templates/design.md`、`templates/feature.md`、`templates/tasks.md`、`templates/execute.md`
- **技能定义：** `skills/design/SKILL.md`、`skills/feat/SKILL.md`、`skills/fix/SKILL.md`、`skills/execute/SKILL.md`
- **项目文档：** `README.md`、`CLAUDE.md`
- **插件元数据：** `.claude-plugin/plugin.json`、`.claude-plugin/marketplace.json`
